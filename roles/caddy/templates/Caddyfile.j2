{% if caddy_enable_http %}
http://{{ server_hostname | default(inventory_hostname) }}{% if caddy_http_port != 80 %}":"+{{ caddy_http_port }}{% endif %} {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  proxy /v2ray localhost:8964 {
    websocket
    header_upstream -Origin
  }
}
{% endif %}
{% if caddy_enable_https %}
https://{{ server_hostname | default(inventory_hostname) }}{% if caddy_https_port != 443 %}":"+{{ caddy_https_port }}{% endif %}/help {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  tls {{ letsencrypt_email }}
  root {{ artifacts_dir }}
  basicauth / {{ caddy_basicauth_username }} {{ caddy_basicauth_password }} {
{% if caddy_basicauth_realm is defined and caddy_basicauth_realm|length > 0 %}
    realm "{{ caddy_basicauth_realm }}"
{% endif %}
  }
}
https://{{ server_hostname | default(inventory_hostname) }}{% if caddy_https_port != 443 %}":"+{{ caddy_https_port }}{% endif %} {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  tls {{ letsencrypt_email }}
  proxy /v2ray localhost:8964 {
    websocket
    header_upstream -Origin
  }
  proxy /dns-query {{ doh_servers | map('quote') | join(' ') }} {
    policy first
    health_check /health
  }
  proxy /resolve https://dns.google.com {
    policy first
    health_check /health
  }
}
{% if cloudflare_domain is defined and cloudflare_domain|length > 0 %}
http://{{ cloudflare_domain }}{% if caddy_http_port != 80 %}":"+{{ caddy_http_port }}{% endif %} {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  proxy /v2ray localhost:8964 {
    websocket
    header_upstream -Origin
  }
}
https://{{ cloudflare_domain }}{% if caddy_https_port != 443 %}":"+{{ caddy_https_port }}{% endif %}/help {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  tls {{ letsencrypt_email }}
  root {{ artifacts_dir }}
  basicauth / {{ caddy_basicauth_username }} {{ caddy_basicauth_password }} {
{% if caddy_basicauth_realm is defined and caddy_basicauth_realm|length > 0 %}
    realm "{{ caddy_basicauth_realm }}"
{% endif %}
  }
}
https://{{ cloudflare_domain }}{% if caddy_https_port != 443 %}":"+{{ caddy_https_port }}{% endif %} {
  log {{ caddy_log_dir }}/{{ caddy_log_file }}
  tls {{ letsencrypt_email }}
  proxy /v2ray localhost:8964 {
    websocket
    header_upstream -Origin
  }
  proxy /dns-query {{ doh_servers | map('quote') | join(' ') }} {
    policy first
    health_check /health
  }
  proxy /resolve https://dns.google.com {
    policy first
    health_check /health
  }
}
{% endif %}
{% endif %}
